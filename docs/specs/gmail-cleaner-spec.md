# Gmail Cleaner CLI - Specification

*Finalized: 2026-02-03*

## Overview

A Python CLI tool that connects to multiple Gmail accounts via OAuth 2.0, fetches inbox emails, classifies them using a local Ollama model (mistral:7b), and automatically applies Gmail labels and archives based on the classification. The tool provides LLM-generated summaries of important categories and allows users to review, edit, and apply or save results.

## Problem Statement

Managing multiple Gmail inboxes is time-consuming. Emails pile up across 3 accounts, mixing important messages with newsletters, notifications, and spam. Manual triage is tedious and often neglected, leading to missed important emails and inbox anxiety.

## Scope

### In Scope
- Multi-account Gmail management (3 accounts, same rules)
- OAuth 2.0 authentication with guided setup
- Email classification via local Ollama LLM
- Automatic label creation and application
- Archiving of low-value emails
- LLM-generated summaries of important categories
- Interactive CLI with arrow-key navigation
- Drill-down to view/edit individual email classifications
- Save pending results for later application
- Configurable settings (model, label names, batch limit)

### Out of Scope (v1)
- Undo actions (user fixes in Gmail directly)
- Scheduled/cron runs (user runs manually)
- Email search/filtering from CLI
- Learning/training from user feedback
- PyPI distribution (local use only)
- Email deletion (archive only)

## User Stories

### US-1: First-Time Setup
**Description:** As a new user, I want guided setup so I can configure Google Cloud credentials and add my first account without reading documentation.

**Acceptance Criteria:**
- [ ] Running `python -m gmail_cleaner` with no config shows setup instructions
- [ ] Instructions include correct URLs for Google Cloud Console
- [ ] Tool validates credentials.json format and reports specific errors
- [ ] After credentials validated, prompts to add first account
- [ ] OAuth browser flow opens and completes successfully
- [ ] Account token saved to ~/.gmail-cleaner/config.json
- [ ] If Ollama not running, offers to start it
- [ ] If model not found, shows exact install command
- [ ] mypy passes with no errors

### US-2: Add Additional Account
**Description:** As a user with existing setup, I want to add another Gmail account.

**Acceptance Criteria:**
- [ ] "Add account" menu option triggers OAuth flow
- [ ] Prompts for account nickname before OAuth
- [ ] New account appears in config.json after completion
- [ ] Account appears in account selection menus
- [ ] mypy passes with no errors

### US-3: Run Cleaner - Classification
**Description:** As a user, I want to classify all inbox emails across my accounts.

**Acceptance Criteria:**
- [ ] Fetches emails from inbox without Auto/* labels
- [ ] Processes both read and unread emails
- [ ] Sends emails to Ollama in batches of 5-10
- [ ] Shows progress indicator during processing
- [ ] Respects max_emails_per_run setting (default: 100)
- [ ] Handles Ollama connection errors gracefully
- [ ] Invalid JSON responses default to FYI category
- [ ] mypy passes with no errors
- [ ] Unit tests pass for classifier logic

### US-4: Run Cleaner - Summary Display
**Description:** As a user, I want to see an LLM-generated summary of important emails after classification.

**Acceptance Criteria:**
- [ ] Shows bullet-list summary for: Needs Reply, Needs Action, FYI
- [ ] Each bullet is one-line description of email content
- [ ] Archive and Ignore show count only, no summary
- [ ] Summary generated by Ollama from classification results
- [ ] Format matches:
  ```
  NEEDS REPLY (3 emails):
  • John wants meeting time for Thursday
  • Boss asked about Q4 project status

  ARCHIVE: 12 emails
  IGNORE: 19 emails
  ```
- [ ] mypy passes with no errors

### US-5: Drill-Down and Edit
**Description:** As a user, I want to review individual emails and override classifications before applying.

**Acceptance Criteria:**
- [ ] After summary, option to drill into any category
- [ ] Shows: sender, subject, snippet for each email
- [ ] Can change email's category with arrow keys
- [ ] Can mark email as "skip" (no action taken)
- [ ] Changes reflected in final apply action
- [ ] Can navigate back to summary
- [ ] mypy passes with no errors

### US-6: Apply Actions
**Description:** As a user, I want to apply the classifications to Gmail.

**Acceptance Criteria:**
- [ ] "Apply now" creates Auto/* labels if they don't exist
- [ ] Applies correct label to each email
- [ ] Archives emails in ARCHIVE and IGNORE categories
- [ ] Skipped emails are not modified
- [ ] Shows completion message with counts
- [ ] mypy passes with no errors

### US-7: Save for Later
**Description:** As a user, I want to save classification results without applying them.

**Acceptance Criteria:**
- [ ] "Save for later" writes results to ~/.gmail-cleaner/pending.json
- [ ] Pending results include: email ID, account, category, skip flag
- [ ] "Apply pending results" menu option appears when pending.json exists
- [ ] Applying pending results works same as immediate apply
- [ ] After apply, pending.json is deleted
- [ ] If pending exists when running cleaner, prompts to apply/discard first
- [ ] mypy passes with no errors

### US-8: Settings Management
**Description:** As a user, I want to configure the tool's behavior.

**Acceptance Criteria:**
- [ ] Settings menu shows: model, label names, max emails per run
- [ ] Can change Ollama model (validates model exists)
- [ ] Can customize label names (e.g., Auto/Needs Reply → Action/Reply)
- [ ] Can change max emails per run (positive integer)
- [ ] Label name changes apply to new emails only
- [ ] Settings saved to config.json
- [ ] mypy passes with no errors

### US-9: Remove Account
**Description:** As a user, I want to remove a Gmail account from the tool.

**Acceptance Criteria:**
- [ ] "Remove account" shows list of configured accounts
- [ ] Selecting account removes it from config.json
- [ ] Confirmation prompt before removal
- [ ] Cannot remove last account (shows warning)
- [ ] mypy passes with no errors

## Technical Design

### Project Structure
```
gmail-cleaner/
├── gmail_cleaner/
│   ├── __init__.py
│   ├── __main__.py       # Entry point
│   ├── cli.py            # Interactive CLI menus (questionary)
│   ├── gmail.py          # Gmail API wrapper
│   ├── classifier.py     # Ollama integration
│   ├── config.py         # Config file management
│   ├── pending.py        # Pending results management
│   └── types.py          # Type definitions
├── tests/
│   ├── test_classifier.py
│   ├── test_config.py
│   └── test_pending.py
├── pyproject.toml
└── README.md
```

### Data Model

**config.json** (~/.gmail-cleaner/config.json):
```json
{
  "model": "mistral:7b",
  "max_emails_per_run": 100,
  "labels": {
    "NEEDS_REPLY": "Auto/Needs Reply",
    "NEEDS_ACTION": "Auto/Needs Action",
    "FYI": "Auto/FYI",
    "ARCHIVE": "Auto/Archive",
    "IGNORE": "Auto/Ignore"
  },
  "accounts": {
    "personal": {
      "email": "user@gmail.com",
      "token": { "access_token": "...", "refresh_token": "...", ... }
    }
  }
}
```

**pending.json** (~/.gmail-cleaner/pending.json):
```json
{
  "created_at": "2026-02-03T10:00:00Z",
  "results": [
    {
      "account": "personal",
      "email_id": "abc123",
      "category": "NEEDS_REPLY",
      "skip": false,
      "subject": "Meeting Thursday?",
      "sender": "john@example.com"
    }
  ]
}
```

### Classification Categories

| Category | Gmail Action | Gets Summary |
|----------|--------------|--------------|
| NEEDS_REPLY | Apply label, stay in inbox | Yes |
| NEEDS_ACTION | Apply label, stay in inbox | Yes |
| FYI | Apply label, stay in inbox | Yes |
| ARCHIVE | Apply label, archive | No (count only) |
| IGNORE | Apply label, archive | No (count only) |

### Gmail API Scopes
- `https://www.googleapis.com/auth/gmail.readonly`
- `https://www.googleapis.com/auth/gmail.modify`
- `https://www.googleapis.com/auth/gmail.labels`

### Email Query
```
is:inbox AND NOT label:Auto/Needs-Reply AND NOT label:Auto/Needs-Action AND NOT label:Auto/FYI AND NOT label:Auto/Archive AND NOT label:Auto/Ignore
```

### LLM Prompts

**Classification prompt:**
```
Classify this email into exactly one category:
- NEEDS_REPLY: Requires a response from me
- NEEDS_ACTION: Requires me to do something (not a reply)
- FYI: Informational, read later, no action needed
- ARCHIVE: Low value, newsletters I don't read, notifications
- IGNORE: Spam, marketing, completely irrelevant

Email:
From: {sender}
Subject: {subject}
Preview: {snippet}
Date: {date}

Respond with JSON only:
{"category": "...", "reason": "one sentence"}
```

**Summary prompt:**
```
Summarize these emails in a bullet list. Each bullet should be one short sentence describing what the email is about.

Emails:
{list of subject + sender + snippet}

Respond with bullet points only, one per email.
```

## User Experience

### Main Menu
```
Gmail Cleaner
─────────────
❯ Run cleaner (all accounts)
  Run cleaner (select account)
  ─────────────
  Apply pending results        ← only if pending.json exists
  ─────────────
  Add account
  Remove account
  Settings
  ─────────────
  Exit
```

### Account Selection
```
Select account:
❯ All accounts
  personal@gmail.com
  work@company.com
  side@gmail.com
```

### Run Flow
1. Check for pending results → prompt to apply/discard if exists
2. Check Ollama running → offer to start if not
3. Fetch emails from selected account(s)
4. Classify in batches, show progress
5. Generate LLM summary for NEEDS_REPLY, NEEDS_ACTION, FYI
6. Display summary
7. Offer drill-down option
8. Final prompt: Apply now / Save for later / Discard

### Settings Menu
```
Settings
────────
❯ Change model (current: mistral:7b)
  Customize label names
  Max emails per run (current: 100)
  Back
```

## Requirements

### Functional Requirements
- FR-1: Support 3 Gmail accounts with identical classification rules
- FR-2: OAuth 2.0 authentication with persistent token storage
- FR-3: Classify emails into 5 categories using local Ollama LLM
- FR-4: Apply Gmail labels automatically based on classification
- FR-5: Archive ARCHIVE and IGNORE category emails
- FR-6: Generate LLM summaries for actionable categories
- FR-7: Allow drill-down to view/edit individual classifications
- FR-8: Support saving results for later application
- FR-9: Configurable label names and batch limits
- FR-10: Skip emails that already have Auto/* labels

### Non-Functional Requirements
- NFR-1: All code must pass mypy strict mode
- NFR-2: Unit tests must cover classifier parsing and config handling
- NFR-3: Batch size of 5-10 emails per Ollama request
- NFR-4: Default max 100 emails per run
- NFR-5: Graceful handling of Ollama connection failures
- NFR-6: Invalid LLM responses default to FYI (safe fallback)

## Implementation Phases

### Phase 1: Foundation
- [ ] Initialize Python project with pyproject.toml
- [ ] Set up dependencies (google-api-python-client, ollama, questionary)
- [ ] Implement config.py with type hints
- [ ] Implement guided setup flow (credentials + first account)
- [ ] Unit tests for config handling
- **Verification:** `mypy gmail_cleaner/ && pytest tests/test_config.py`

### Phase 2: Gmail Integration
- [ ] Implement OAuth flow for adding/removing accounts
- [ ] Implement email fetching with Auto/* label exclusion
- [ ] Implement label creation (create if not exists)
- [ ] Implement label application and archiving
- **Verification:** `mypy gmail_cleaner/ && pytest`

### Phase 3: Classification
- [ ] Implement classifier.py with Ollama integration
- [ ] Implement batch processing (5-10 emails per request)
- [ ] Implement JSON parsing with FYI fallback
- [ ] Implement summary generation prompt
- [ ] Unit tests for classifier parsing
- **Verification:** `mypy gmail_cleaner/ && pytest tests/test_classifier.py`

### Phase 4: CLI Interface
- [ ] Implement main menu with questionary
- [ ] Implement run flow (fetch → classify → summarize → prompt)
- [ ] Implement drill-down view with edit/skip
- [ ] Implement pending.py for save/apply later
- [ ] Implement settings menu
- [ ] Unit tests for pending logic
- **Verification:** `mypy gmail_cleaner/ && pytest`

## Definition of Done

This feature is complete when:
- [ ] All user story acceptance criteria pass
- [ ] All implementation phases verified
- [ ] Tests pass: `pytest`
- [ ] Types/lint check: `mypy gmail_cleaner/ --strict`
- [ ] Tool runs end-to-end with real Gmail account

## Verification Commands

```bash
# Type checking
mypy gmail_cleaner/ --strict

# Run tests
pytest

# Run the tool
python -m gmail_cleaner
```

## Open Questions

None - all questions resolved during interview.

## Implementation Notes

*To be filled during implementation.*

---

<promise>SPEC COMPLETE</promise>
